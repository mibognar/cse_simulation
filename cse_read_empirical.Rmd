---
title: "cse_read_empirical"
author: "Miklos Bognar"
date: "2024-02-14"
output: html_document
---

```{r}
library(osfr)
library(dplyr)
library(tidyverse)
library(papaja)
library(EZ2)
library(rtdists)
source("utils.R")
```
## Read empirical dataframes
#### Flanker 2020
An online control experiment from 2 separate data collections. No response deadline
```{r}
osf_retrieve_file("hsdxk") %>%
  osf_download(path = "data/empirical")
```

#### Primeprobe 2020
An online control experiment from 2 separate data collections. 2000ms response deadline
```{r}
osf_retrieve_file("w4nzj") %>%
  osf_download(path = "data/empirical")

primeprobe2020 = read_tsv("data/empirical/prime_probe_global_raw_data.tsv")

primeprobe2020 = primeprobe2020 %>% 
  mutate(rt = response_time - probe_onset,
         correct = ifelse(response_target == response_content, 1,0),
         prev_correct = ifelse(lag(correct)==1,1,0),
         prev_congruent = ifelse(lag(is_congruent)==1, 1,0),
         first_trial = ifelse(block != lag(block),1,0)) %>% 
  select(is_practice,is_congruent,prev_congruent,correct,prev_correct,rt,first_trial)
```

#### Flanker 2023
An online experiment, one data collection. 
```{r}
osf_retrieve_file("eu6rq") %>%
  osf_download(path = "data/empirical")

flanker2023 = read_csv("data/empirical/zhang_replication_data.csv")

```


## Flanker 2020
#### Read data, calculate response times and remove unused variables
```{r}
flanker2020 = read_tsv("data/empirical/flanker_raw_data.tsv")
flanker2020 =flanker2020 %>% 
  mutate(rt = response_time - stim_onset,
         correct = ifelse(response_target == response_content, 1,0),
         prev_correct = ifelse(lag(correct)==1,1,0),
         prev_congruent = ifelse(lag(is_congruent)==1, 1,0),
         first_trial = ifelse(block != lag(block),1,0)) %>% 
  dplyr::select(participant_id,is_practice,is_congruent,prev_congruent,correct,prev_correct,rt,first_trial)
```

#### remove responses longer that 2000ms; practice trials and first trials of block
```{r}
flanker2020_processed = flanker2020 %>% 
  filter(rt<2400,
         rt>250,
         is_practice == 0,
         first_trial == 0)
```

#### rt distribution
```{r}
flanker2020_congruent = flanker2020_processed %>% 
  filter(is_congruent == 1)
flanker2020_incongruent = flanker2020_processed %>% 
  filter(is_congruent == 0)

ggplot()+
  geom_histogram(aes(x = rt),
                 data = flanker2020_incongruent, fill = "red", alpha=.2)+
  geom_histogram(aes(x = rt),
                 data = flanker2020_congruent, fill = "blue", alpha=.4)
```
#### CSE summary
```{r}
flanker2020_summary_parameters = flanker2020_processed %>% 
  group_by(participant_id,is_congruent, prev_congruent) %>% 
  summarize(N = n(),
            mean_rt = mean(rt, na.rm=T)/1000,
            var_rt = var(rt, na.rm=T)/1000000,
            sd_rt = sd(rt, na.rm=T)/1000,
            correct_percent = mean(correct, n.rm=T)) %>% 
  ungroup()
```
#### CSE participant summary 
```{r}
cse_participant = flanker2020_processed %>% 
  group_by(participant_id) %>% 
  summarize(var_rt = var(rt,na.rm=T)/1000000)

hist(cse_participant$var_rt)
```
#random participants
```{r}
testdf = data.frame(participant_id = 1:300,
                    rt_rand = rnorm(300, 1, .05),
                    var_rand = rnorm(300,1,.05),
                    correct_rand = rnorm(300,1,.05)) %>% 
  uncount(2) %>% 
  mutate(is_congruent = rep(0:1, each=1, length.out=n())) %>% 
  uncount(2) %>% 
  mutate(prev_congruent = rep(0:1, each=1, length.out=n()))
```


```{r}
flanker2020_summary_parameters %>% 
  ggplot()+
  aes(x=correct_percent) +
  geom_histogram(bins = 30)+
  xlim(.75,1.1)

mean(flanker2020_summary_parameters$correct_percent)
```

```{r}
flanker2020_summary_parameters %>% 
  ggplot()+
  aes(x=var_rt) +
  geom_histogram(bins = 30)

mean(flanker2020_summary_parameters$var_rt)
```

### Simulate correct_percent
```{r}
#
desired_mean <- 0.9475356  # Set your desired mean
alpha <- 12  # Fixed alpha

# Calculate beta based on the desired mean and fixed alpha
beta <- alpha * ((1 / desired_mean) - 1)

# Generate data
data <- rbeta(2500, alpha, beta)
data = rbeta(2000,1,10.63261)

# Verify the mean
mean(data)
ggplot()+
  aes(x=data) +
  geom_histogram(bins = 30)

min(data)*.99
```

### Simulate rt var
```{r}
#
desired_mean <- 0.08596523  # Set your desired mean
alpha <- 1  # Fixed alpha

# Calculate beta based on the desired mean and fixed alpha
beta <- alpha * ((1 / desired_mean) - 1)

# Generate data
data <- rbeta(2500, alpha, beta)
randata = rnorm(20000,mean = 0, sd = .1)

hist(randata)

# Verify the mean
mean(data)
ggplot()+
  aes(x=data) +
  geom_histogram(bins = 30)

max(data)
```

# create EZ parameters from condition data
```{r}
diffusion_parameters_data <- flanker2020_summary_parameters %>%
  filter(correct_percent>.5) %>% 
  mutate(Result = pmap(list(
    ifelse(correct_percent==1, 1-1/(N*2),correct_percent),
    var_rt,
    mean_rt,
    s=1),
    Data2EZ),
         v = map_dbl(Result, "v"),
         a = map_dbl(Result, "a"),
         Ter = map_dbl(Result, "Ter")) %>% 
  dplyr::select(-Result)
```

TEST DATA
```{r}
testdf = diffusion_parameters_data %>%
 # filter(Ter>.1) %>% 
  mutate(Result=pmap(
    list(80,
         a=a,
         v=v,
         t0=Ter),
    rdiffusion)) %>% 
  unnest(Result)

test_lower = testdf %>% filter(response=="lower")
test_upper = testdf %>% filter(response=="upper")

ggplot() +
  aes(x=rt)+
  geom_histogram(data = test_lower, fill="red", alpha=.6)+
  geom_histogram(data = test_upper, fill="blue", alpha=.4)+
  xlim(0,2.5)
head(testdf)
```

```{r}
test_upper %>% 
  filter(participant_id == 45) %>% 
  group_by(is_congruent, prev_congruent) %>% 
  summarize(mean_rt =mean(rt, na.rm = T)) %>% 
  ggplot()+
  aes(x=as.factor(prev_congruent), y=mean_rt, color=as.factor(is_congruent), group=as.factor(is_congruent))+
  geom_point()+
  geom_path()
```



```{r}
testframe2 = flanker2020 %>% 
  filter(rt<1500)

ggplot() +
  aes(x=rt) %>% 
  geom_histogram(data = testframe2)

flanker2020_processed_correct =flanker2020_processed%>% 
  filter(correct == 1)
flanker2020_processed_incorrect =flanker2020_processed%>% 
  filter(correct == 0)

ggplot() +
  aes(x=rt)+
  geom_histogram(data = flanker2020_processed_incorrect, fill="red", alpha=.6)+
  geom_histogram(data = flanker2020_processed_correct, fill="blue", alpha=.4)
```
