---
title: "read_simulations"
output: html_document
date: "2024-06-11"
---
```{r}
library(tidyverse)
library(ez)
library(rempsyc)
```

```{r}
directory <- "data/simulated_v6/simulated"

# List all CSV files in the directory
csv_files <- list.files(path = directory, pattern = "*.csv", full.names = TRUE)

# Function to read a CSV file and add a filename column
read_csv_with_filename <- function(file) {
  read_csv(file) %>%
    mutate(filename = basename(file))
}

# Read all CSV files and combine them into one dataframe
combined_df <- csv_files %>%
  map_dfr(read_csv_with_filename)
```

```{r}
split_filename <- function(df) {
  df %>%
    mutate(
      effect = str_extract(filename, "^[^_]+_[^_]+"),
      # Split the filename by underscores and extract the relevant parts
      split_parts = str_split(filename, "_", simplify = TRUE),
      participants = split_parts[, 3],
      trials = split_parts[, 4]
    ) %>%
    select(-filename, -split_parts) # Optionally remove the original filename and split_parts columns
}

# Apply the function to the combined dataframe
final_df <- combined_df %>%
  split_filename()
```

```{r}
SD_data_big = final_df %>% 
  filter(effect !="no_effect") %>% 
  mutate(all_tests = (glmm_intercept_slope + full_melr + intercept_melr + intercept_melr)/4)

SD_data_big %>% 
  group_by(filtering) %>% 
  summarize(mean_total = mean(all_tests))
```
```{r}
models_data = final_df %>% 
  filter(effect != "no_effect") %>% 
  group_by(participants, trials) %>%
  mutate(total = (glmm_intercept_slope + full_melr + intercept_melr + intercept_melr)/4) %>% 
  summarize(mean_glmm = mean(glmm_intercept_slope),
            mean_lmm_slope = mean(full_melr),
            mean_lmm_intercept = mean(intercept_melr),
            mean_anova = mean(anova_rt)
            )

models_data = models_data %>% 
  pivot_longer(cols = starts_with("mean"),
               names_to = "model",
               values_to = "TPR")
```


```{r}
models_data_false = final_df %>% 
  filter(effect == "no_effect") %>% 
  group_by(participants, trials) %>%
  mutate(total = (glmm_intercept_slope + full_melr + intercept_melr + intercept_melr)/4) %>% 
  summarize(mean_glmm = mean(glmm_intercept_slope),
            mean_lmm_slope = mean(full_melr),
            mean_lmm_intercept = mean(intercept_melr),
            mean_anova = mean(anova_rt)
            )

models_data_false = models_data_false %>% 
  pivot_longer(cols = starts_with("mean"),
               names_to = "model",
               values_to = "FPR")
```

```{r}
models_data_roc = models_data %>% 
  left_join(., models_data_false, by=c("participants","trials","model"))
```

### Plotting ROC data for models
```{r}
models_data_roc = models_data_roc[order(models_data_roc$TPR),]
models_data_roc$FPR <- factor(models_data_roc$FPR, levels = models_data_roc$FPR)

trials80_ROC = models_data_roc %>%
  filter(trials == 80) %>% 
  arrange(as.numeric(TPR)) %>% 
  ggplot(aes(x=FPR, y=TPR, color=model, shape=participants, group=model))+
  geom_point()+
  geom_path()+
  scale_x_continuous(limits = c(0, .15))+
  scale_y_continuous(limits = c(0, 1))+
  labs(title = "Model ROC performance on 80 trials / condition",
       )+
  scale_color_discrete(name="Model type", labels=c("ANOVA", "GLMM", "Simple LMM", "Complex LMM"))+
  theme_classic()
trials80_ROC
```

```{r}
trials160_ROC = models_data_roc %>%
  filter(trials == 160) %>% 
  arrange(as.numeric(TPR)) %>% 
  ggplot(aes(x=FPR, y=TPR, color=model, shape=participants, group=model))+
  geom_point()+
  geom_path()+
  scale_x_continuous(limits = c(0, .15))+
  scale_y_continuous(limits = c(0, 1))+
  labs(title = "Model ROC performance on 160 trials / condition",
       )+
  scale_color_discrete(name="Model type", labels=c("ANOVA", "GLMM", "Simple LMM", "Complex LMM"))+
  theme_classic()

trials160_ROC
```
```{r}
tpr_data = models_data %>% group_by(model) %>% 
  summarize(mean_TPR = mean(TPR),
            sd_TPR = sd(TPR),
            N = n(),
            ) %>% 
  mutate(se_TPR = sd_TPR / sqrt(N),
         lower = mean_TPR-qt(.975, N-1)*se_TPR,
          upper = mean_TPR+qt(.975, N-1)*se_TPR)
```

```{r}
nice_table(tpr_data)
```

```{r}
models_FPR = models_data_false %>% group_by(model) %>% 
  summarize(mean_FPR = mean(FPR),
            sd_FPR = sd(FPR),
            N = n(),
            ) %>% 
  mutate(se_FPR = sd_FPR / sqrt(N),
         lower = mean_FPR-qt(.975, N-1)*se_FPR,
          upper = mean_FPR+qt(.975, N-1)*se_FPR)

nice_table(models_FPR)
```


```{r}
SD_data_false_big = final_df %>% 
  filter(effect == "no_effect") %>% 
  group_by(filtering, participants, trials) %>%
  mutate(FPR = (glmm_intercept_slope + full_melr + intercept_melr + intercept_melr)/4) %>% 
  summarize(FPR = mean(FPR))

SD_data_true_big = final_df %>% 
  filter(effect != "no_effect") %>% 
  group_by(filtering, participants, trials) %>%
  mutate(TPR = (glmm_intercept_slope + full_melr + intercept_melr + intercept_melr)/4) %>% 
  summarize(TPR = mean(TPR))

SD_data_big = SD_data_false_big %>% 
  left_join(., SD_data_true_big, by = c("filtering","participants","trials"))


```

### Plotting SD filter data
```{r}
SD_data_80_plot = SD_data_big %>% 
  filter(trials == 80) %>% 
  arrange(as.numeric(TPR)) %>% 
  ggplot(aes(x=FPR, y=TPR, color=filtering, shape=participants, group=filtering))+
  geom_point()+
  geom_path()+
  scale_x_continuous(limits = c(0, .15))+
  scale_y_continuous(limits = c(0, 1))+
  labs(title = "SD filtering ROC performance on 80 trials / condition",
       )+
  scale_color_discrete(name="Filtering treshold", labels=c("No filter", "2.5SD filter", "3SD filter"))+
  theme_classic()

SD_data_80_plot

```
```{r}
SD_data_160_plot = SD_data_big %>% 
  filter(trials == 160) %>% 
  arrange(as.numeric(TPR)) %>% 
  ggplot(aes(x=FPR, y=TPR, color=filtering, shape=participants, group=filtering))+
  geom_point()+
  geom_path()+
  scale_x_continuous(limits = c(0, .15))+
  scale_y_continuous(limits = c(0, 1))+
  labs(title = "SD filtering ROC performance on 160 trials / condition",
       )+
  scale_color_discrete(name="Filtering treshold", labels=c("No filter", "2.5SD filter", "3SD filter"))+
  theme_classic()

SD_data_160_plot

```
```{r}
SD_tpr = SD_data_big %>% group_by(filtering) %>% 
  summarize(mean_TPR = mean(TPR),
            sd_TPR = sd(TPR),
            N = n(),
            ) %>% 
  mutate(se_TPR = sd_TPR / sqrt(N),
         lower = mean_TPR-qt(.975, N-1)*se_TPR,
          upper = mean_TPR+qt(.975, N-1)*se_TPR)
```

```{r}
SD_fpr = SD_data_big %>% group_by(filtering) %>% 
  summarize(mean_FPR = mean(FPR),
            sd_FPR = sd(FPR),
            N = n(),
            ) %>% 
  mutate(se_FPR = sd_FPR / sqrt(N),
         lower = mean_FPR-qt(.975, N-1)*se_FPR,
          upper = mean_FPR+qt(.975, N-1)*se_FPR)
```


